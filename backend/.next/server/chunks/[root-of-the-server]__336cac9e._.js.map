{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 234, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/xero/test/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { XeroClient, AccountingApi } from 'xero-node'\nimport { PrismaClient } from '@prisma/client'\n\nconst prisma = new PrismaClient()\n\nfunction getXeroClient() {\n  const clientId = process.env.XERO_CLIENT_ID\n  const clientSecret = process.env.XERO_CLIENT_SECRET\n  const redirectUri = process.env.XERO_REDIRECT_URI\n  const scopes = process.env.XERO_SCOPES?.split(' ') || []\n\n  console.log('=== XERO CLIENT INITIALIZATION DEBUG ===')\n  console.log('clientId:', clientId ? `${clientId.substring(0, 8)}...` : 'MISSING')\n  console.log('clientSecret:', clientSecret ? `${clientSecret.substring(0, 8)}...` : 'MISSING')\n  console.log('redirectUri:', redirectUri)\n  console.log('scopes:', scopes)\n  console.log('XERO_SCOPES env var:', process.env.XERO_SCOPES)\n\n  if (!clientId || !clientSecret || !redirectUri) {\n    const error = `Missing Xero environment variables: clientId=${!!clientId}, clientSecret=${!!clientSecret}, redirectUri=${!!redirectUri}`\n    console.error('ERROR:', error)\n    throw new Error(error)\n  }\n\n  const xeroConfig = {\n    clientId,\n    clientSecret,\n    redirectUris: [redirectUri],\n    scopes,\n  }\n  \n  console.log('XeroClient config:', {\n    ...xeroConfig,\n    clientSecret: clientSecret ? '[HIDDEN]' : 'MISSING'\n  })\n\n  try {\n    const client = new XeroClient(xeroConfig)\n    console.log('XeroClient created successfully')\n    return client\n  } catch (error) {\n    console.error('Error creating XeroClient:', error)\n    throw error\n  }\n}\n\n// CORS preflight\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    },\n  })\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get('userId')\n\n    console.log('=== XERO TEST ENDPOINT DEBUG ===')\n    console.log('userId:', userId)\n\n    // Test XeroClient initialization first\n    console.log('\\n=== TESTING XERO CLIENT INITIALIZATION ===')\n    try {\n      const testXero = getXeroClient()\n      console.log('XeroClient initialization test: SUCCESS')\n    } catch (error) {\n      console.log('XeroClient initialization test: FAILED')\n      console.error('XeroClient error:', error)\n    }\n    console.log('=== END XERO CLIENT TEST ===\\n')\n\n    if (!userId) {\n      console.log('ERROR: No userId provided')\n      return NextResponse.json(\n        { error: 'User ID is required' },\n        { status: 400 }\n      )\n    }\n\n    // Get user's Xero tokens from database\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n      select: {\n        xeroAccessToken: true,\n        xeroRefreshToken: true,\n        xeroTokenExpiry: true,\n        xeroTenantId: true,\n        xeroTenantName: true,\n      },\n    })\n\n    console.log('User found:', !!user)\n    console.log('User xeroAccessToken:', user?.xeroAccessToken ? `${user.xeroAccessToken.substring(0, 10)}...` : 'MISSING')\n    console.log('User xeroRefreshToken:', user?.xeroRefreshToken ? `${user.xeroRefreshToken.substring(0, 10)}...` : 'MISSING')\n    console.log('User xeroTenantId:', user?.xeroTenantId)\n    console.log('User xeroTenantName:', user?.xeroTenantName)\n    console.log('User xeroTokenExpiry:', user?.xeroTokenExpiry)\n\n    if (!user || !user.xeroAccessToken || !user.xeroTenantId) {\n      console.log('ERROR: User not connected to Xero or missing tokens')\n      console.log('Missing:', {\n        user: !user,\n        xeroAccessToken: !user?.xeroAccessToken,\n        xeroTenantId: !user?.xeroTenantId\n      })\n      return NextResponse.json(\n        { error: 'User not connected to Xero or missing tokens' },\n        { status: 401 }\n      )\n    }\n\n    // Check if token is expired\n    const now = new Date()\n    const tokenExpiry = user.xeroTokenExpiry ? new Date(user.xeroTokenExpiry) : null\n    \n    if (tokenExpiry && now >= tokenExpiry) {\n      return NextResponse.json(\n        { error: 'Xero token has expired. Please reconnect.' },\n        { status: 401 }\n      )\n    }\n\n    // Initialize Xero client\n    const xero = getXeroClient()\n    \n    // Set the access token\n    await xero.setTokenSet({\n      access_token: user.xeroAccessToken,\n      refresh_token: user.xeroRefreshToken || undefined,\n      expires_at: tokenExpiry?.getTime(),\n    })\n\n    // Create accounting API instance\n    const accountingApi = xero.accountingApi\n\n    // Fetch accounts from Xero\n    const accountsResponse = await accountingApi.getAccounts(\n      user.xeroTenantId\n    )\n\n    const accounts = accountsResponse.body.accounts || []\n\n    return NextResponse.json({\n      success: true,\n      tenantId: user.xeroTenantId,\n      tenantName: user.xeroTenantName,\n      accountsCount: accounts.length,\n      accounts: accounts.map(account => ({\n        accountID: account.accountID,\n        code: account.code,\n        name: account.name,\n        type: account.type,\n        status: account.status,\n        description: account.description,\n        class: account._class,\n        systemAccount: account.systemAccount,\n        enablePaymentsToAccount: account.enablePaymentsToAccount,\n        showInExpenseClaims: account.showInExpenseClaims,\n        bankAccountNumber: account.bankAccountNumber,\n        bankAccountType: account.bankAccountType,\n        currencyCode: account.currencyCode,\n      })),\n    })\n  } catch (error: any) {\n    console.error('Error fetching Xero accounts:', error)\n    \n    // Handle specific Xero API errors\n    if (error.response) {\n      const status = error.response.status\n      const message = error.response.data?.message || error.message\n      \n      if (status === 401) {\n        return NextResponse.json(\n          { error: 'Unauthorized: Invalid or expired Xero token' },\n          { status: 401 }\n        )\n      } else if (status === 403) {\n        return NextResponse.json(\n          { error: 'Forbidden: Insufficient permissions for Xero API' },\n          { status: 403 }\n        )\n      } else {\n        return NextResponse.json(\n          { error: `Xero API error: ${message}` },\n          { status: status }\n        )\n      }\n    }\n    \n    return NextResponse.json(\n      { error: 'Failed to fetch accounts from Xero', details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    await prisma.$disconnect()\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}