{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 114, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/documents/upload/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { writeFile, mkdir } from 'fs/promises'\nimport { join } from 'path'\nimport { existsSync } from 'fs'\nimport { prisma } from '@/lib/prisma'\n\n// Handle CORS preflight requests\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    },\n  })\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData()\n    const file = formData.get('file') as File\n    const userId = formData.get('userId') as string\n    const companyId = formData.get('companyId') as string\n\n    if (!file) {\n      return NextResponse.json({ error: 'No file provided' }, { \n        status: 400,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    if (!userId) {\n      return NextResponse.json({ error: 'User ID is required' }, { \n        status: 400,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    // Validate file type\n    const allowedTypes = process.env.ALLOWED_FILE_TYPES?.split(',') || [\n      'image/jpeg',\n      'image/png', \n      'image/gif',\n      'application/pdf'\n    ]\n    \n    if (!allowedTypes.includes(file.type)) {\n      return NextResponse.json(\n        { error: `File type ${file.type} not allowed. Allowed types: ${allowedTypes.join(', ')}` },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Validate file size\n    const maxSize = parseInt(process.env.MAX_FILE_SIZE || '10485760') // 10MB default\n    if (file.size > maxSize) {\n      return NextResponse.json(\n        { error: `File size ${file.size} exceeds maximum allowed size of ${maxSize} bytes` },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Create uploads directory if it doesn't exist\n    const uploadsDir = join(process.cwd(), 'uploads')\n    if (!existsSync(uploadsDir)) {\n      await mkdir(uploadsDir, { recursive: true })\n    }\n\n    // Generate unique filename\n    const timestamp = Date.now()\n    const fileName = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`\n    const filePath = join(uploadsDir, fileName)\n\n    // Validate user exists\n    const userExists = await prisma.user.findUnique({\n      where: { id: userId }\n    })\n    \n    if (!userExists) {\n      return NextResponse.json({ error: 'User not found' }, { \n        status: 404,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    // Validate company exists if companyId is provided\n    if (companyId) {\n      const companyExists = await prisma.company.findUnique({\n        where: { id: companyId }\n      })\n      \n      if (!companyExists) {\n        return NextResponse.json({ error: 'Company not found' }, { \n          status: 404,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        })\n      }\n    }\n\n    // Save file to disk\n    const bytes = await file.arrayBuffer()\n    const buffer = Buffer.from(bytes)\n    await writeFile(filePath, buffer)\n\n    // Save document record to database\n    const document = await prisma.document.create({\n      data: {\n        fileName,\n        originalName: file.name,\n        filePath: `uploads/${fileName}`,\n        fileSize: file.size,\n        mimeType: file.type,\n        status: 'QUEUE',\n        userId,\n        companyId: companyId || null,\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n        company: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n      },\n    })\n\n    return NextResponse.json({\n      success: true,\n      document,\n      message: 'File uploaded successfully',\n    }, {\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n      },\n    })\n  } catch (error) {\n    console.error('Upload error:', error)\n    return NextResponse.json(\n      { error: 'Failed to upload file' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  } finally {\n    await prisma.$disconnect()\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}