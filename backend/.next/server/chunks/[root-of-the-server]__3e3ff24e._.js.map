{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport bcrypt from 'bcryptjs';\nimport { prisma } from '@/lib/prisma';\n\ninterface LoginRequest {\n  email: string;\n  password?: string;\n  // OAuth fields\n  isOAuthUser?: boolean;\n  oauthProvider?: string;\n  oauthId?: string;\n}\n\n// Handle CORS preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  });\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body: LoginRequest = await request.json();\n    const { \n      email, \n      password, \n      isOAuthUser = false,\n      oauthProvider,\n      oauthId\n    } = body;\n\n    // Validate required fields\n    if (!email) {\n      return NextResponse.json(\n        { error: 'Email обязателен' },\n        { status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // Find user by email\n    const user = await prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        password: true,\n        name: true,\n        userType: true,\n        phone: true,\n        company: true,\n        services: true,\n        isOAuthUser: true,\n        oauthProvider: true,\n        oauthId: true,\n        isVisibleToClients: true,\n        acceptsJobOffers: true,\n        isActive: true,\n        isDeleted: true,\n        createdAt: true\n      }\n    });\n\n    if (!user) {\n      return NextResponse.json(\n        { error: 'Пользователь не найден' },\n        { status: 404,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // Check if account is active\n    if (!user.isActive || user.isDeleted) {\n      return NextResponse.json(\n        { error: 'Аккаунт деактивирован или удален' },\n        { status: 403,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // Handle OAuth login\n    if (isOAuthUser) {\n      if (!user.isOAuthUser) {\n        return NextResponse.json(\n          { error: 'Этот аккаунт зарегистрирован через email. Используйте вход по паролю.' },\n          { status: 400 }\n        );\n      }\n\n      if (user.oauthProvider !== oauthProvider || user.oauthId !== oauthId) {\n        return NextResponse.json(\n          { error: 'Неверные OAuth данные' },\n          { status: 401 }\n        );\n      }\n    } else {\n      // Handle email/password login\n      if (user.isOAuthUser) {\n        return NextResponse.json(\n          { error: `Этот аккаунт зарегистрирован через ${user.oauthProvider}. Используйте OAuth вход.` },\n          { status: 400 }\n        );\n      }\n\n      if (!password) {\n        return NextResponse.json(\n          { error: 'Пароль обязателен' },\n          { status: 400 }\n        );\n      }\n\n      if (!user.password) {\n        return NextResponse.json(\n          { error: 'Пароль не установлен для этого аккаунта' },\n          { status: 400 }\n        );\n      }\n\n      const isPasswordValid = await bcrypt.compare(password, user.password);\n      if (!isPasswordValid) {\n        return NextResponse.json(\n          { error: 'Неверный пароль' },\n          { status: 401,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n              'Access-Control-Allow-Methods': 'POST, OPTIONS',\n              'Access-Control-Allow-Headers': 'Content-Type',\n            }\n          }\n        );\n      }\n    }\n\n    // Remove password from response\n    const { password: _, ...userWithoutPassword } = user;\n\n    return NextResponse.json({\n      message: 'Успешный вход',\n      user: userWithoutPassword\n    }, { \n      status: 200,\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      }\n    });\n\n  } catch (error) {\n    console.error('Login error:', error);\n    return NextResponse.json(\n      { error: 'Внутренняя ошибка сервера' },\n      { status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n          'Access-Control-Allow-Methods': 'POST, OPTIONS',\n          'Access-Control-Allow-Headers': 'Content-Type',\n        }\n      }\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}