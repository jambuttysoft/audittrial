{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/auth/register/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport bcrypt from 'bcryptjs';\nimport { prisma } from '@/lib/prisma';\n\ninterface RegisterRequest {\n  email: string;\n  password?: string;\n  name: string;\n  userType: 'INDIVIDUAL' | 'BUSINESS';\n  phone?: string;\n  company?: string;\n  services?: string;\n  // OAuth fields\n  isOAuthUser?: boolean;\n  oauthProvider?: string;\n  oauthId?: string;\n}\n\n// Handle CORS preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  });\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body: RegisterRequest = await request.json();\n    const { \n      email, \n      password, \n      name, \n      userType, \n      phone, \n      company, \n      services,\n      isOAuthUser = false,\n      oauthProvider,\n      oauthId\n    } = body;\n\n    // Validate required fields\n    if (!email || !name || !userType) {\n      return NextResponse.json(\n        { error: 'Email, имя и тип пользователя обязательны' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // For non-OAuth users, password is required\n    if (!isOAuthUser && !password) {\n      return NextResponse.json(\n        { error: 'Пароль обязателен' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // For OAuth users, provider and ID are required\n    if (isOAuthUser && (!oauthProvider || !oauthId)) {\n      return NextResponse.json(\n        { error: 'OAuth провайдер и ID обязательны для OAuth регистрации' },\n        { status: 400 }\n      );\n    }\n\n    // Check if user already exists\n    const existingUser = await prisma.user.findUnique({\n      where: { email }\n    });\n\n    if (existingUser) {\n      return NextResponse.json(\n        { error: 'Пользователь с таким email уже существует' },\n        { \n          status: 409,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n            'Access-Control-Allow-Methods': 'POST, OPTIONS',\n            'Access-Control-Allow-Headers': 'Content-Type',\n          }\n        }\n      );\n    }\n\n    // Hash password for non-OAuth users\n    let hashedPassword = null;\n    if (!isOAuthUser && password) {\n      hashedPassword = await bcrypt.hash(password, 12);\n    }\n\n    // Create new user\n    const newUser = await prisma.user.create({\n      data: {\n        email,\n        password: hashedPassword,\n        name,\n        userType,\n        phone,\n        company,\n        services,\n        isOAuthUser,\n        oauthProvider,\n        oauthId,\n        isActive: true,\n        isDeleted: false,\n        isVisibleToClients: userType === 'BUSINESS',\n        acceptsJobOffers: userType === 'BUSINESS'\n      },\n      select: {\n        id: true,\n        email: true,\n        name: true,\n        userType: true,\n        phone: true,\n        company: true,\n        services: true,\n        isOAuthUser: true,\n        oauthProvider: true,\n        isVisibleToClients: true,\n        acceptsJobOffers: true,\n        isActive: true,\n        createdAt: true\n      }\n    });\n\n    // Automatically create a company if user is BUSINESS type or company name is provided\n    let createdCompany = null;\n    if (userType === 'BUSINESS' || company) {\n      const companyName = company || `${name}'s Company`;\n      \n      try {\n        createdCompany = await prisma.company.create({\n          data: {\n            name: companyName,\n            description: services || undefined,\n            email: email,\n            phone: phone || undefined,\n            userId: newUser.id,\n            isActive: true\n          },\n          select: {\n            id: true,\n            name: true,\n            description: true,\n            email: true,\n            phone: true,\n            isActive: true,\n            createdAt: true\n          }\n        });\n      } catch (companyError) {\n        console.error('Company creation error:', companyError);\n        // Don't fail the registration if company creation fails\n      }\n    }\n\n    return NextResponse.json({\n      message: 'Пользователь успешно зарегистрирован',\n      user: newUser,\n      company: createdCompany\n    }, { \n      status: 201,\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n        'Access-Control-Allow-Methods': 'POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type',\n      }\n    });\n\n  } catch (error) {\n    console.error('Registration error:', error);\n    return NextResponse.json(\n      { error: 'Внутренняя ошибка сервера' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n          'Access-Control-Allow-Methods': 'POST, OPTIONS',\n          'Access-Control-Allow-Headers': 'Content-Type',\n        }\n      }\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}