{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/documents/%5Bid%5D/digitize/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { GoogleGenerativeAI } from '@google/generative-ai'\nimport { PrismaClient } from '@prisma/client'\nimport fs from 'fs'\nimport path from 'path'\n\nconst prisma = new PrismaClient()\n\n// Initialize Gemini AI\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '')\n\ninterface ReceiptData {\n  receipt_id?: string\n  date: string\n  supplier: {\n    name: string\n    abn?: string\n  }\n  total_amount: number\n  currency: string\n  gst_summary?: {\n    gst_inclusive?: number\n    gst_amount?: number\n    gst_free?: number\n    zero_rated?: number\n  }\n  line_items?: Array<{\n    description: string\n    quantity: number\n    unit_price: number\n    tax_type?: string\n    gst_rate?: number\n    gst_amount?: number\n    total: number\n  }>\n  payment?: {\n    method: string[]\n    split?: Array<{\n      type: string\n      amount: number\n    }>\n  }\n  is_refund?: boolean\n  location?: string\n  note?: string\n}\n\nexport async function POST(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\n  try {\n    const body = await request.json()\n    const { userId } = body\n    const { id } = await params\n\n    if (!userId) {\n      return NextResponse.json({ error: 'User ID is required' }, { \n        status: 400,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    // Get document from database\n    const document = await prisma.document.findFirst({\n      where: {\n        id: id,\n        userId: userId\n      }\n    })\n\n    if (!document) {\n      return NextResponse.json({ error: 'Document not found' }, { \n        status: 404,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    // Check if document is an image\n    if (!document.mimeType.startsWith('image/')) {\n      return NextResponse.json({ error: 'Document must be an image' }, { \n        status: 400,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n    }\n\n    // Update status to processing\n    await prisma.document.update({\n      where: { id: id },\n      data: { status: 'PROCESSING' }\n    })\n\n    try {\n      // Read the image file\n      const imagePath = path.join(process.cwd(), document.filePath)\n      const imageBuffer = fs.readFileSync(imagePath)\n      const base64Image = imageBuffer.toString('base64')\n\n      // Initialize Gemini model\n      const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' })\n\n      const prompt = `\nAnalyze this image and determine if it's a receipt or invoice. If it's NOT a receipt/invoice, return exactly: {\"error\": \"Not a receipt\"}\n\nIf it IS a receipt/invoice, extract the following information and return it as a JSON object with this exact structure:\n\n{\n  \"receipt_id\": \"receipt number if available\",\n  \"date\": \"YYYY-MM-DD format\",\n  \"supplier\": {\n    \"name\": \"business name\",\n    \"abn\": \"ABN if available\"\n  },\n  \"total_amount\": 0.00,\n  \"currency\": \"AUD or detected currency\",\n  \"gst_summary\": {\n    \"gst_inclusive\": 0.00,\n    \"gst_amount\": 0.00,\n    \"gst_free\": 0.00,\n    \"zero_rated\": 0.00\n  },\n  \"line_items\": [\n    {\n      \"description\": \"item name\",\n      \"quantity\": 1,\n      \"unit_price\": 0.00,\n      \"tax_type\": \"GST Inclusive/GST Free/Zero Rated\",\n      \"gst_rate\": 0.10,\n      \"gst_amount\": 0.00,\n      \"total\": 0.00\n    }\n  ],\n  \"payment\": {\n    \"method\": [\"Card\", \"Cash\"],\n    \"split\": [\n      { \"type\": \"Card\", \"amount\": 0.00 },\n      { \"type\": \"Cash\", \"amount\": 0.00 }\n    ]\n  },\n  \"is_refund\": false,\n  \"location\": \"state or location if available\",\n  \"note\": \"any additional notes\"\n}\n\nReturn ONLY the JSON object, no additional text or formatting.\n`\n\n      const result = await model.generateContent([\n        prompt,\n        {\n          inlineData: {\n            data: base64Image,\n            mimeType: document.mimeType\n          }\n        }\n      ])\n\n      const response = await result.response\n      let text = response.text()\n      \n      // Clean up markdown formatting if present\n      if (text.includes('```json')) {\n        // Remove markdown code blocks\n        text = text.replace(/```json\\s*/g, '').replace(/\\s*```/g, '')\n      }\n      \n      // Additional cleanup - remove any extra whitespace and hidden characters\n      text = text.trim()\n      \n      // Parse the JSON response\n      let receiptData: ReceiptData | { error: string }\n      try {\n        receiptData = JSON.parse(text)\n      } catch (parseError) {\n        console.error('JSON parse error:', parseError)\n        console.error('Failed to parse Gemini response:', text.substring(0, 200))\n        throw new Error(`Invalid JSON response from Gemini: ${parseError}`)\n      }\n\n      // Check if it's an error response (not a receipt)\n      if ('error' in receiptData) {\n        await prisma.document.update({\n          where: { id: id },\n          data: { status: 'DELETED' }\n        })\n        return NextResponse.json({ \n          message: 'Файл не является чеком и был перемещен в удаленные файлы',\n          status: 'DELETED'\n        }, { \n          status: 200,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        })\n      }\n\n      // Update document with digitized data\n      const updatedDocument = await prisma.document.update({\n        where: { id: id },\n        data: {\n          status: 'DIGITIZED',\n          processedDate: new Date(),\n          transactionDate: receiptData.date ? new Date(receiptData.date) : null,\n          vendor: receiptData.supplier.name,\n          abn: receiptData.supplier.abn,\n          totalAmount: receiptData.total_amount,\n          gstAmount: receiptData.gst_summary?.gst_amount,\n          description: receiptData.note,\n          paymentMethod: receiptData.payment?.method.join(', '),\n          documentType: 'RECEIPT',\n          receiptData: receiptData as any // Store full JSON data\n        }\n      })\n\n      return NextResponse.json({\n        success: true,\n        document: updatedDocument,\n        receiptData: receiptData\n      }, {\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      })\n\n    } catch (error) {\n      console.error('Error processing with Gemini:', error)\n      \n      // Update status to error\n      await prisma.document.update({\n        where: { id: id },\n        data: { status: 'ERROR' }\n      })\n\n      return NextResponse.json(\n        { error: 'Failed to process document with AI' },\n        { \n          status: 500,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n  } catch (error) {\n    console.error('Error in digitize endpoint:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  }\n}\n\n// OPTIONS method for CORS preflight\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  })\n}"],"names":[],"mappings":"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","debugId":null}}]
}