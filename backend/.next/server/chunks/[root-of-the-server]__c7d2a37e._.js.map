{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport bcrypt from 'bcryptjs'\nimport jwt from 'jsonwebtoken'\nimport { prisma } from '@/lib/prisma'\n\n// Request/Response interfaces\ninterface LoginRequest {\n  email: string\n  password?: string\n  isOAuthUser?: boolean\n  oauthProvider?: string\n  oauthId?: string\n}\n\ninterface LoginResponse {\n  success: boolean\n  message: string\n  user?: {\n    id: string\n    email: string\n    name: string | null\n    userType: string\n    isOAuthUser: boolean\n  }\n  token?: string\n}\n\n// Handle CORS preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n    },\n  })\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { email, password, isOAuthUser = false, oauthProvider, oauthId }: LoginRequest = await request.json()\n\n    // Validate required fields\n    if (!email) {\n      return NextResponse.json(\n        { success: false, message: 'Email is required' } as LoginResponse,\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // For OAuth users, validate OAuth fields\n    if (isOAuthUser && (!oauthProvider || !oauthId)) {\n      return NextResponse.json(\n        { success: false, message: 'OAuth provider and ID are required for OAuth login' } as LoginResponse,\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // For regular users, validate password\n    if (!isOAuthUser && !password) {\n      return NextResponse.json(\n        { success: false, message: 'Password is required' } as LoginResponse,\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Find user by email\n    const user = await prisma.user.findUnique({\n      where: { email },\n      select: {\n        id: true,\n        email: true,\n        password: true,\n        name: true,\n        userType: true,\n        isOAuthUser: true,\n        oauthProvider: true,\n        oauthId: true,\n        isActive: true,\n        isDeleted: true,\n      },\n    })\n\n    if (!user) {\n      return NextResponse.json(\n        { success: false, message: 'Invalid email or password' } as LoginResponse,\n        { \n          status: 401,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Check if user account is active\n    if (!user.isActive || user.isDeleted) {\n      return NextResponse.json(\n        { success: false, message: 'Account is deactivated' } as LoginResponse,\n        { \n          status: 401,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Handle OAuth login\n    if (isOAuthUser) {\n      if (!user.isOAuthUser || user.oauthProvider !== oauthProvider || user.oauthId !== oauthId) {\n        return NextResponse.json(\n          { success: false, message: 'Invalid OAuth credentials' } as LoginResponse,\n          { \n            status: 401,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n            },\n          }\n        )\n      }\n    } else {\n      // Handle regular password login\n      if (user.isOAuthUser || !user.password) {\n        return NextResponse.json(\n          { success: false, message: 'This account uses OAuth login' } as LoginResponse,\n          { \n            status: 401,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n            },\n          }\n        )\n      }\n\n      // Verify password\n      const isPasswordValid = await bcrypt.compare(password!, user.password)\n      if (!isPasswordValid) {\n        return NextResponse.json(\n          { success: false, message: 'Invalid email or password' } as LoginResponse,\n          { \n            status: 401,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n            },\n          }\n        )\n      }\n    }\n\n    // Generate JWT token\n    const token = jwt.sign(\n      { \n        userId: user.id, \n        email: user.email,\n        userType: user.userType \n      },\n      process.env.JWT_SECRET || 'fallback-secret-key',\n      { expiresIn: '7d' }\n    )\n\n    // Return success response\n    return NextResponse.json(\n      {\n        success: true,\n        message: 'Login successful',\n        user: {\n          id: user.id,\n          email: user.email,\n          name: user.name,\n          userType: user.userType,\n          isOAuthUser: user.isOAuthUser,\n        },\n        token,\n      } as LoginResponse,\n      { \n        status: 200,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  } catch (error) {\n    console.error('Login error:', error)\n    return NextResponse.json(\n      { success: false, message: 'Internal server error' } as LoginResponse,\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}