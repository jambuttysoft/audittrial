{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 90, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: ['query'],\n  })\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/extdisk/WORK/audittrial/backend/src/app/api/companies/%5Bid%5D/files/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { writeFile, mkdir } from 'fs/promises'\nimport { join } from 'path'\nimport { prisma } from '@/lib/prisma'\n\n// Handle CORS preflight requests\nexport async function OPTIONS(request: NextRequest) {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': 'http://localhost:3000',\n      'Access-Control-Allow-Methods': 'GET, POST, DELETE, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  })\n}\n\n// GET /api/companies/[id]/files - получить все файлы компании\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: { id: string } }\n) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const userId = searchParams.get('userId')\n\n    if (!userId) {\n      return NextResponse.json(\n        { error: 'User ID is required' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Проверяем, что компания принадлежит пользователю\n    const company = await prisma.company.findFirst({\n      where: {\n        id: params.id,\n        userId,\n        isActive: true,\n      },\n    })\n\n    if (!company) {\n      return NextResponse.json(\n        { error: 'Company not found' },\n        { \n          status: 404,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Получаем все документы компании\n    const documents = await prisma.document.findMany({\n      where: {\n        companyId: params.id,\n        userId,\n      },\n      orderBy: {\n        uploadDate: 'desc',\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            name: true,\n            email: true,\n          },\n        },\n        company: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n      },\n    })\n\n    return NextResponse.json(documents, {\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n      },\n    })\n  } catch (error) {\n    console.error('Error fetching company files:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  }\n}\n\n// POST /api/companies/[id]/files - загрузить файл для компании\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: { id: string } }\n) {\n  try {\n    const formData = await request.formData()\n    const files = formData.getAll('files') as File[]\n    const userId = formData.get('userId') as string\n\n    if (!files || files.length === 0) {\n      return NextResponse.json(\n        { error: 'No files uploaded' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    if (!userId) {\n      return NextResponse.json(\n        { error: 'User ID is required' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Проверяем, что компания принадлежит пользователю\n    const company = await prisma.company.findFirst({\n      where: {\n        id: params.id,\n        userId,\n        isActive: true,\n      },\n    })\n\n    if (!company) {\n      return NextResponse.json(\n        { error: 'Company not found' },\n        { \n          status: 404,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    const uploadedDocuments = []\n    const maxSize = parseInt(process.env.MAX_FILE_SIZE || '10485760') // 10MB\n    const allowedTypes = process.env.ALLOWED_FILE_TYPES?.split(',') || [\n      'image/jpeg',\n      'image/png',\n      'image/gif',\n      'image/webp',\n      'application/pdf',\n    ]\n\n    // Создаем директорию uploads если её нет\n    const uploadDir = process.env.UPLOAD_DIR || './uploads'\n    await mkdir(uploadDir, { recursive: true })\n\n    for (const file of files) {\n      // Проверяем размер файла\n      if (file.size > maxSize) {\n        return NextResponse.json(\n          { error: `File ${file.name} exceeds size limit` },\n          { \n            status: 413,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n            },\n          }\n        )\n      }\n\n      // Проверяем тип файла\n      if (!allowedTypes.includes(file.type)) {\n        return NextResponse.json(\n          { error: `File type ${file.type} not allowed for ${file.name}` },\n          { \n            status: 415,\n            headers: {\n              'Access-Control-Allow-Origin': 'http://localhost:3000',\n            },\n          }\n        )\n      }\n\n      // Создаем уникальное имя файла\n      const timestamp = Date.now()\n      const fileName = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`\n      \n      // Путь к файлу\n      const filePath = join(uploadDir, fileName)\n      \n      // Сохраняем файл\n      const bytes = await file.arrayBuffer()\n      const buffer = Buffer.from(bytes)\n      await writeFile(filePath, buffer)\n\n      // Сохраняем информацию о файле в базе данных\n      const document = await prisma.document.create({\n        data: {\n          fileName,\n          originalName: file.name,\n          filePath,\n          fileSize: file.size,\n          mimeType: file.type,\n          userId,\n          companyId: params.id,\n          status: 'QUEUE',\n        },\n        include: {\n          user: {\n            select: {\n              id: true,\n              name: true,\n              email: true,\n            },\n          },\n          company: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n      })\n\n      uploadedDocuments.push(document)\n    }\n\n    return NextResponse.json({\n      message: `${uploadedDocuments.length} file(s) uploaded successfully`,\n      documents: uploadedDocuments,\n    }, { \n      status: 201,\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n      },\n    })\n\n  } catch (error) {\n    console.error('Error uploading files:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  }\n}\n\n// DELETE /api/companies/[id]/files - удалить выбранные файлы компании\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: { id: string } }\n) {\n  try {\n    const body = await request.json()\n    const { documentIds, userId } = body\n\n    if (!documentIds || !Array.isArray(documentIds) || documentIds.length === 0) {\n      return NextResponse.json(\n        { error: 'Document IDs are required' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    if (!userId) {\n      return NextResponse.json(\n        { error: 'User ID is required' },\n        { \n          status: 400,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Проверяем, что компания принадлежит пользователю\n    const company = await prisma.company.findFirst({\n      where: {\n        id: params.id,\n        userId,\n        isActive: true,\n      },\n    })\n\n    if (!company) {\n      return NextResponse.json(\n        { error: 'Company not found' },\n        { \n          status: 404,\n          headers: {\n            'Access-Control-Allow-Origin': 'http://localhost:3000',\n          },\n        }\n      )\n    }\n\n    // Удаляем документы\n    const deleteResult = await prisma.document.deleteMany({\n      where: {\n        id: {\n          in: documentIds,\n        },\n        companyId: params.id,\n        userId,\n      },\n    })\n\n    return NextResponse.json({\n      message: `${deleteResult.count} document(s) deleted successfully`,\n      deletedCount: deleteResult.count,\n    }, {\n      headers: {\n        'Access-Control-Allow-Origin': 'http://localhost:3000',\n      },\n    })\n  } catch (error) {\n    console.error('Error deleting documents:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { \n        status: 500,\n        headers: {\n          'Access-Control-Allow-Origin': 'http://localhost:3000',\n        },\n      }\n    )\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}