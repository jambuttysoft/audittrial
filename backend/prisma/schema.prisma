// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  
  // Authentication fields
  password  String?  // null for OAuth users
  isOAuthUser Boolean @default(false)
  oauthProvider String? // "google", "facebook", etc.
  oauthId   String?  // OAuth provider user ID
  
  // Email verification
  isVerified Boolean @default(false)
  verificationToken String? @unique
  
  // Password reset
  resetToken String? @unique
  resetTokenExpiry DateTime?
  
  // Profile information
  name      String?
  userType  UserType @default(INDIVIDUAL)
  role      UserRole @default(USER)
  
  // Contact information
  phone     String?
  address   String?
  website   String?
  avatar    String?  // URL to profile photo
  
  // Professional information
  company   String?  // Company name if business
  abn      String?  // Australian Business Number for business users
  services  String?  // Description of services offered
  
  // Visibility settings
  isVisibleToClients Boolean @default(false)
  acceptsJobOffers   Boolean @default(false)
  
  // Account status
  isActive  Boolean  @default(true)
  isDeleted Boolean  @default(false)
  
  // Xero integration fields
  xeroAccessToken    String?   @db.Text
  xeroRefreshToken   String?   @db.Text
  xeroTokenExpiry    DateTime? // When the access token expires
  xeroTenantId       String?   // Xero tenant/organisation ID
  xeroTenantName     String?   // Xero organisation name
  xeroConnectedAt    DateTime? // When Xero was first connected

  stripeCustomerId       String?  @unique
  defaultPaymentMethodId String?
  autoChargeEnabled      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  documents Document[]
  companies Company[]
  digitized Digitized[]
  invoices  Invoice[]
  tickets   Ticket[] @relation("TicketUser")
  assignedTickets Ticket[] @relation("TicketAssignee")
  ticketReplies TicketReply[]
  ticketAttachments TicketAttachment[]
  
  @@map("users")
}

model Company {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  // Contact information
  email       String?
  phone       String?
  address     String?
  website     String?
  
  // Business information
  abn         String?  // Australian Business Number
  industry    String?
  taxRegion   TaxRegion?
  
  // Xero organisation mapping (per company)
  xeroTenantId   String?
  xeroTenantName String?
  xeroBankAccountId String?
  xeroBankAccountName String?
  xeroCashOutAccountCode String?
  xeroCashOutAccountName String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Relations
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   Document[]
  digitized   Digitized[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("companies")
}

model Document {
  id              String            @id @default(cuid())
  fileName        String
  originalName    String
  filePath        String
  fileSize        Int
  mimeType        String
  status          DocumentStatus    @default(QUEUE)
  uploadDate      DateTime          @default(now())
  processedDate   DateTime?
  
  // Digitized data fields - все необходимые поля для парсинга документов
  purchaseDate    DateTime?         // Purchase Date
  vendorName      String?           // Vendor Name
  vendorAbn       String?           // Vendor ABN
  vendorAddress   String?           // Vendor Address
  documentType    String?           // Document Type (invoice/receipt)
  receiptNumber   String?           // Receipt/Invoice Number
  paymentType     String?           // Payment Type
  amountExclTax   Float?            // Amount Excl. Tax
  taxAmount       Float?            // Tax Amount (GST)
  totalAmount     Float?            // Total Amount
  expenseCategory String?           // Expense Category
  taxStatus       String?           // Tax Status
  
  // Legacy fields (для обратной совместимости)
  transactionDate DateTime?
  vendor          String?
  abn             String?
  gstAmount       Float?
  description     String?
  paymentMethod   String?
  transactionStatus String?
  
  // Full receipt data from Gemini API
  receiptData     Json?             // Stores complete parsed receipt data
  
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId       String?
  company         Company?          @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@map("documents")
}

enum DocumentStatus {
  QUEUE
  PROCESSING
  DIGITIZED
  ERROR
}

enum UserType {
  INDIVIDUAL    // Частное лицо (бухгалтер-фрилансер)
  BUSINESS      // Компания
}

enum UserRole {
  ADMIN
  SUPPORT
  USER
  GUEST
}

enum TaxRegion {
  AU
  NZ
  UK
  US
  EU
  CA
  OTHER
}

// Модель для оцифрованных документов
model Digitized {
  id                String    @id @default(cuid())
  companyId         String
  userId            String
  originalDocumentId String   @unique // Ссылка на оригинальный документ
  
  // Основная информация о документе
  fileName          String
  originalName      String
  filePath          String
  fileSize          Int
  mimeType          String
  
  // Извлеченные данные
  purchaseDate      DateTime?
  vendorName        String?
  vendorAbn         String?
  vendorAddress     String?
  documentType      String?
  receiptNumber     String?
  paymentType       String?
  cashOutAmount     Float?
  discountAmount    Float?
  subTotal          Float?
  amountExclTax     Float?
  taxAmount         Float?
  totalAmount       Float?
  totalPaidAmount   Float?
  surchargeAmount   Float?
  expenseCategory   String?
  taxStatus         String?
  taxType           String?
  taxTypeName       String?
  lineItems         Json?
  xeroApiRequests   Json?
  
  // Метаданные
  digitizedAt       DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Связи
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("digitized")
}

model Vendor {
  id                     String   @id @default(cuid())
  abn                    String   @unique
  abnStatus              String?
  abnStatusEffectiveFrom DateTime?
  acn                    String?
  addressDate            DateTime?
  addressPostcode        String?
  addressState           String?
  businessName           Json?
  entityName             String?
  entityTypeCode         String?
  entityTypeName         String?
  gst                    DateTime?
  message                String?
  requestUpdateDate      DateTime
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("vendors")
}

model DigitizedReview {
  id                String    @id @default(cuid())
  originalDigitizedId String  @unique
  companyId         String
  userId            String
  originalDocumentId String
  fileName          String
  originalName      String
  filePath          String
  fileSize          Int
  mimeType          String
  purchaseDate      DateTime?
  vendorName        String?
  vendorAbn         String?
  vendorAddress     String?
  documentType      String?
  receiptNumber     String?
  paymentType       String?
  cashOutAmount     Float?
  discountAmount    Float?
  subTotal          Float?
  amountExclTax     Float?
  taxAmount         Float?
  totalAmount       Float?
  totalPaidAmount   Float?
  surchargeAmount   Float?
  expenseCategory   String?
  taxStatus         String?
  taxType           String?
  taxTypeName       String?
  lineItems         Json?
  xeroApiRequests   Json?
  movedAt           DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("digitized_review")
}

model DigitizedReady {
  id                 String    @id @default(cuid())
  originalDigitizedId String   @unique
  companyId          String
  userId             String
  originalDocumentId String
  fileName           String
  originalName       String
  filePath           String
  fileSize           Int
  mimeType           String
  purchaseDate       DateTime?
  vendorName         String?
  vendorAbn          String?
  vendorAddress      String?
  documentType       String?
  receiptNumber      String?
  paymentType        String?
  cashOutAmount      Float?
  discountAmount     Float?
  subTotal           Float?
  amountExclTax      Float?
  taxAmount          Float?
  totalAmount        Float?
  totalPaidAmount    Float?
  surchargeAmount    Float?
  expenseCategory    String?
  taxStatus          String?
  taxType            String?
  taxTypeName        String?
  lineItems          Json?
  xeroApiRequests    Json?
  movedAt            DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@map("digitized_ready")
}

model DigitizedReported {
  id                  String    @id @default(cuid())
  originalDigitizedId String    @unique
  companyId           String
  userId              String
  originalDocumentId  String
  fileName            String
  originalName        String
  filePath            String
  fileSize            Int
  mimeType            String
  purchaseDate        DateTime?
  vendorName          String?
  vendorAbn           String?
  vendorAddress       String?
  documentType        String?
  receiptNumber       String?
  paymentType         String?
  cashOutAmount       Float?
  discountAmount      Float?
  subTotal            Float?
  amountExclTax       Float?
  taxAmount           Float?
  totalAmount         Float?
  totalPaidAmount     Float?
  surchargeAmount      Float?
  expenseCategory      String?
  taxStatus            String?
  taxType              String?
  taxTypeName          String?
  lineItems            Json?
  xeroApiRequests      Json?
  exportedAt          DateTime
  exportFileName      String
  exportStatus        String
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("digitized_reported")
}

model ExportHistory {
  id           String   @id @default(cuid())
  companyId    String
  userId       String
  fileName     String
  exportedAt   DateTime @default(now())
  status       String
  totalRows    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("export_history")
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

model Invoice {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  periodStart    DateTime
  periodEnd      DateTime
  generatedAt    DateTime      @default(now())
  activeCompanies Int
  amount         Float
  status         InvoiceStatus @default(PENDING)
  paidAt         DateTime?
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("invoices")
}

model Ticket {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("TicketUser", fields: [userId], references: [id], onDelete: Cascade)
  type      String
  subject   String
  body      String
  status    TicketStatus @default(OPEN)
  assigneeId String?
  assignee   User?    @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  claimedAt  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  replies   TicketReply[]
  attachments TicketAttachment[]

  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
}

model TicketReply {
  id        String   @id @default(cuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attachments TicketAttachment[]

  @@map("ticket_replies")
}

model TicketAttachment {
  id         String   @id @default(cuid())
  ticketId   String?
  replyId    String?
  userId     String
  fileName   String
  filePath   String
  mimeType   String
  fileSize   Int
  uploadedAt DateTime @default(now())

  ticket     Ticket?  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  reply      TicketReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ticket_attachments")
}
